name: Build and Compare Outputs

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build-and-test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set executable paths
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "BUILD_DIR=build/Debug" >> $GITHUB_ENV
            echo "EXEC_SUFFIX=.exe" >> $GITHUB_ENV
          else
            echo "BUILD_DIR=build" >> $GITHUB_ENV
            echo "EXEC_SUFFIX=" >> $GITHUB_ENV
          fi

      - name: Configure CMake
        run: cmake -B build

      - name: Build
        run: cmake --build build --config Debug

      - name: Run example_write
        shell: bash
        run: |
          echo "Moving into build directory: ${{ env.BUILD_DIR }}"
          cd ${{ env.BUILD_DIR }}
          
          echo "Running example_write..."
          ./example_write${{ env.EXEC_SUFFIX }} "${{ github.workspace }}/Aip-Gores.map"
          
          echo "Listing files in build dir:"
          ls -l

      - name: Run example_read and filter output
        shell: bash
        run: |
          echo "Moving into build directory: ${{ env.BUILD_DIR }}"
          cd ${{ env.BUILD_DIR }}

          echo "Running example_read..."
          ./example_read${{ env.EXEC_SUFFIX }} generated.demo | grep -v "Timestamp:" > "${{ github.workspace }}/output.txt"
          
          echo "--- Captured Output ---"
          cat "${{ github.workspace }}/output.txt"
          echo "-----------------------"
          
      - name: Archive output
        uses: actions/upload-artifact@v4
        with:
          name: output-${{ matrix.os }}
          path: output.txt

  compare-outputs:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Download all outputs
        uses: actions/download-artifact@v4
        with:
          path: outputs

      - name: Compare and report
        shell: bash
        run: |
          cd outputs
          LINUX_FILE=output-ubuntu-latest/output.txt
          MACOS_FILE=output-macos-latest/output.txt
          WINDOWS_FILE=output-windows-latest/output.txt

          echo "### All Outputs"
          echo "<details><summary>Linux Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat $LINUX_FILE >> $GITHUB_STEP_SUMMARY
          echo '```</details>' >> $GITHUB_STEP_SUMMARY

          echo "<details><summary>macOS Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat $MACOS_FILE >> $GITHUB_STEP_SUMMARY
          echo '```</details>' >> $GITHUB_STEP_SUMMARY

          echo "<details><summary>Windows Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat $WINDOWS_FILE >> $GITHUB_STEP_SUMMARY
          echo '```</details>' >> $GITHUB_STEP_SUMMARY

          echo "### Comparison"
          DIFF_LINUX_MACOS=$(diff -u $LINUX_FILE $MACOS_FILE || true)
          DIFF_LINUX_WINDOWS=$(diff -u $LINUX_FILE $WINDOWS_FILE || true)

          ERROR_COUNT=0

          if [ -n "$DIFF_LINUX_MACOS" ]; then
            echo "::error::Linux and macOS outputs differ!"
            echo "<details><summary> Linux vs macOS Diff</summary>" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF_LINUX_MACOS" >> $GITHUB_STEP_SUMMARY
            echo '```</details>' >> $GITHUB_STEP_SUMMARY
            ERROR_COUNT=$((ERROR_COUNT + 1))
          else
            echo "Linux and macOS outputs match."
            echo "Linux and macOS outputs match." >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$DIFF_LINUX_WINDOWS" ]; then
            echo "::error::Linux and Windows outputs differ!"
            echo "<details><summary> Linux vs Windows Diff</summary>" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF_LINUX_WINDOWS" >> $GITHUB_STEP_SUMMARY
            echo '```</details>' >> $GITHUB_STEP_SUMMARY
            ERROR_COUNT=$((ERROR_COUNT + 1))
          else
            echo "Linux and Windows outputs match."
            echo "Linux and Windows outputs match." >> $GITHUB_STEP_SUMMARY
          fi

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "Differences found!"
            exit 1
          fi
          
          echo "All outputs are identical!"
          echo "All outputs are identical!" >> $GITHUB_STEP_SUMMARY